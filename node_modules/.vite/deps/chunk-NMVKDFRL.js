import {
  DEFAULT_RPC_URL,
  getThirdwebDomains
} from "./chunk-MHFR2GDE.js";
import {
  isThirdwebUrl
} from "./chunk-CVWITOXT.js";

// node_modules/thirdweb/dist/esm/utils/promise/withCache.js
var promiseCache = /* @__PURE__ */ new Map();
var responseCache = /* @__PURE__ */ new Map();
function getCache(cacheKey) {
  const buildCache = (cacheKey_, cache) => ({
    clear: () => cache.delete(cacheKey_),
    get: () => cache.get(cacheKey_),
    set: (data) => cache.set(cacheKey_, data)
  });
  const promise = buildCache(cacheKey, promiseCache);
  const response = buildCache(cacheKey, responseCache);
  return {
    clear: () => {
      promise.clear();
      response.clear();
    },
    promise,
    response
  };
}
async function withCache(fn, { cacheKey, cacheTime = Number.POSITIVE_INFINITY }) {
  const cache = getCache(cacheKey);
  const response = cache.response.get();
  if (response && cacheTime > 0) {
    const age = (/* @__PURE__ */ new Date()).getTime() - response.created.getTime();
    if (age < cacheTime) {
      return response.data;
    }
  }
  let promise = cache.promise.get();
  if (!promise) {
    promise = fn();
    cache.promise.set(promise);
  }
  try {
    const data = await promise;
    cache.response.set({ created: /* @__PURE__ */ new Date(), data });
    return data;
  } finally {
    cache.promise.clear();
  }
}

// node_modules/thirdweb/dist/esm/chains/utils.js
var CUSTOM_CHAIN_MAP = /* @__PURE__ */ new Map();
function defineChain(options) {
  if (typeof options === "number") {
    return {
      id: options,
      rpc: `https://${options}.rpc.thirdweb.com`
    };
  }
  if (isViemChain(options)) {
    return convertViemChain(options);
  }
  if (isLegacyChain(options)) {
    return convertLegacyChain(options);
  }
  let rpc = options.rpc;
  if (!rpc) {
    rpc = `https://${options.id}.rpc.thirdweb.com`;
  }
  const chain = { ...options, rpc };
  CUSTOM_CHAIN_MAP.set(options.id, chain);
  return chain;
}
function getCachedChain(id) {
  if (CUSTOM_CHAIN_MAP.has(id)) {
    return CUSTOM_CHAIN_MAP.get(id);
  }
  const chain = {
    id,
    rpc: `https://${id}.rpc.thirdweb.com`
  };
  return chain;
}
function isLegacyChain(chain) {
  return "rpc" in chain && Array.isArray(chain.rpc) && "slug" in chain;
}
function convertLegacyChain(legacyChain) {
  var _a;
  const c = {
    id: legacyChain.chainId,
    name: legacyChain.name,
    rpc: legacyChain.rpc[0] ?? `https://${legacyChain.chainId}.rpc.thirdweb.com`,
    blockExplorers: (_a = legacyChain == null ? void 0 : legacyChain.explorers) == null ? void 0 : _a.map((explorer) => ({
      name: explorer.name,
      url: explorer.url,
      apiUrl: explorer.url
    })),
    nativeCurrency: {
      name: legacyChain.nativeCurrency.name,
      symbol: legacyChain.nativeCurrency.symbol,
      decimals: legacyChain.nativeCurrency.decimals
    }
  };
  if (legacyChain.testnet) {
    return { ...c, testnet: true };
  }
  return c;
}
function isViemChain(chain) {
  return "rpcUrls" in chain && !("rpc" in chain);
}
function convertViemChain(viemChain) {
  return defineChain({
    id: viemChain.id,
    name: viemChain.name,
    nativeCurrency: {
      name: viemChain.nativeCurrency.name,
      symbol: viemChain.nativeCurrency.symbol,
      decimals: viemChain.nativeCurrency.decimals
    },
    rpc: viemChain.rpcUrls.default.http[0] ?? `https://${viemChain.id}.rpc.thirdweb.com`,
    blockExplorers: (viemChain == null ? void 0 : viemChain.blockExplorers) ? Object.values(viemChain == null ? void 0 : viemChain.blockExplorers).map((explorer) => {
      return {
        name: explorer.name,
        url: explorer.url,
        apiUrl: explorer.apiUrl
      };
    }) : []
  });
}
function getRpcUrlForChain(options) {
  const baseRpcUrl = getThirdwebDomains().rpc;
  if (typeof options.chain === "number") {
    return `https://${options.chain}.${baseRpcUrl}/${options.client.clientId}`;
  }
  const { rpc } = options.chain;
  if (isThirdwebUrl(rpc)) {
    const rpcUrl = new URL(options.chain.rpc.replace(DEFAULT_RPC_URL, baseRpcUrl));
    rpcUrl.pathname = `/${options.client.clientId}`;
    return rpcUrl.toString();
  }
  return rpc;
}
async function getChainSymbol(chain) {
  var _a;
  if (!((_a = chain.nativeCurrency) == null ? void 0 : _a.symbol)) {
    return getChainMetadata(chain).then((data) => data.nativeCurrency.symbol).catch(() => {
      return "ETH";
    });
  }
  return chain.nativeCurrency.symbol;
}
async function getChainDecimals(chain) {
  var _a;
  if (!((_a = chain.nativeCurrency) == null ? void 0 : _a.decimals)) {
    return getChainMetadata(chain).then((data) => data.nativeCurrency.decimals).catch(() => {
      return 18;
    });
  }
  return chain.nativeCurrency.decimals;
}
async function getChainNativeCurrencyName(chain) {
  var _a;
  if (!((_a = chain.nativeCurrency) == null ? void 0 : _a.name)) {
    return getChainMetadata(chain).then((data) => data.nativeCurrency.name).catch(() => {
      return "ETH";
    });
  }
  return chain.nativeCurrency.name;
}
function getChainMetadata(chain) {
  const chainId = chain.id;
  return withCache(async () => {
    var _a;
    try {
      const res = await fetch(`https://api.thirdweb.com/v1/chains/${chainId}`);
      if (!res.ok) {
        (_a = res.body) == null ? void 0 : _a.cancel();
        throw new Error(`Failed to fetch chain data for chainId ${chainId}`);
      }
      const response = await res.json();
      if (response.error) {
        throw new Error(`Failed to fetch chain data for chainId ${chainId}`);
      }
      if (!response.data) {
        throw new Error(`Failed to fetch chain data for chainId ${chainId}`);
      }
      const data = response.data;
      return createChainMetadata(chain, data);
    } catch {
      return createChainMetadata(chain);
    }
  }, {
    cacheKey: `chain:${chainId}`,
    cacheTime: 5 * 60 * 1e3
    // 5 minutes
  });
}
function convertApiChainToChain(apiChain) {
  var _a;
  return {
    id: apiChain.chainId,
    name: apiChain.name,
    rpc: apiChain.rpc[0] || "",
    testnet: apiChain.testnet === true ? true : void 0,
    nativeCurrency: apiChain.nativeCurrency,
    blockExplorers: (_a = apiChain.explorers) == null ? void 0 : _a.map((explorer) => {
      return {
        name: explorer.name,
        url: explorer.url,
        apiUrl: explorer.url
      };
    })
  };
}
function createChainMetadata(chain, data) {
  var _a;
  const nativeCurrency = chain.nativeCurrency ? {
    ...data == null ? void 0 : data.nativeCurrency,
    ...chain.nativeCurrency
  } : data == null ? void 0 : data.nativeCurrency;
  return {
    ...data,
    name: chain.name || (data == null ? void 0 : data.name) || "",
    chainId: chain.id || (data == null ? void 0 : data.chainId) || -1,
    rpc: chain.rpc ? [chain.rpc] : (data == null ? void 0 : data.rpc) || [""],
    testnet: chain.testnet || (data == null ? void 0 : data.testnet) || false,
    nativeCurrency: {
      name: (nativeCurrency == null ? void 0 : nativeCurrency.name) || "",
      symbol: (nativeCurrency == null ? void 0 : nativeCurrency.symbol) || "",
      decimals: (nativeCurrency == null ? void 0 : nativeCurrency.decimals) || 18
    },
    icon: chain.icon || (data == null ? void 0 : data.icon),
    chain: (data == null ? void 0 : data.chain) || chain.name || "",
    shortName: (data == null ? void 0 : data.shortName) || chain.name || "",
    slug: (data == null ? void 0 : data.slug) || chain.name || "",
    explorers: ((_a = chain.blockExplorers) == null ? void 0 : _a.map((e) => ({
      name: e.name,
      url: e.url,
      standard: "EIP3091"
    }))) || (data == null ? void 0 : data.explorers)
  };
}

export {
  withCache,
  defineChain,
  getCachedChain,
  getRpcUrlForChain,
  getChainSymbol,
  getChainDecimals,
  getChainNativeCurrencyName,
  getChainMetadata,
  convertApiChainToChain
};
//# sourceMappingURL=chunk-NMVKDFRL.js.map
